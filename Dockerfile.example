# Dockerfile for running Lence with example project
# Build: docker build -f Dockerfile.example -t lence-example .
# Run:   docker run -p 8000:8000 lence-example

# Stage 1: Build frontend assets
FROM node:20-slim AS frontend

WORKDIR /build

COPY package.json package-lock.json ./
RUN npm ci

COPY vite.config.ts tsconfig.json ./
COPY lence/frontend/ lence/frontend/

RUN npm run build

# Stage 2: Python runtime
FROM python:3.11-slim

WORKDIR /app

# Install uv for faster package installation
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Copy Python package files
COPY pyproject.toml README.md ./
COPY lence/ lence/

# Copy built frontend from stage 1
COPY --from=frontend /build/lence/static/js/ lence/static/js/

# Install the package
RUN uv pip install --system .

# Copy example project
COPY example/ /app/example/

EXPOSE 8000

CMD ["lence", "serve", "/app/example"]
